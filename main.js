/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var X=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var ue=Object.prototype.hasOwnProperty;var se=(h,l)=>()=>(l||h((l={exports:{}}).exports,l),l.exports),pe=(h,l)=>{for(var e in l)X(h,e,{get:l[e],enumerable:!0})},he=(h,l,e,t)=>{if(l&&typeof l=="object"||typeof l=="function")for(let s of ge(l))!ue.call(h,s)&&s!==e&&X(h,s,{get:()=>l[s],enumerable:!(t=de(l,s))||t.enumerable});return h};var me=h=>he(X({},"__esModule",{value:!0}),h);var ne=se(O=>{O.Image={11:"ProcessingSoftware",254:"NewSubfileType",255:"SubfileType",256:"ImageWidth",257:"ImageLength",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Thresholding",264:"CellWidth",265:"CellLength",266:"FillOrder",269:"DocumentName",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",285:"PageName",286:"XPosition",287:"YPosition",290:"GrayResponseUnit",291:"GrayResponseCurve",292:"T4Options",293:"T6Options",296:"ResolutionUnit",297:"PageNumber",301:"TransferFunction",305:"Software",306:"DateTime",315:"Artist",316:"HostComputer",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",320:"ColorMap",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",330:"SubIFDs",332:"InkSet",333:"InkNames",334:"NumberOfInks",336:"DotRange",337:"TargetPrinter",338:"ExtraSamples",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",512:"JPEGProc",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",700:"XMLPacket",18246:"Rating",18249:"RatingPercent",28722:"VignettingCorrParams",28725:"ChromaticAberrationCorrParams",28727:"DistortionCorrParams",32781:"ImageID",33421:"CFARepeatPatternDim",33422:"CFAPattern",33423:"BatteryLevel",33432:"Copyright",33434:"ExposureTime",33437:"FNumber",33723:"IPTCNAA",34377:"ImageResources",34665:"ExifTag",34675:"InterColorProfile",34850:"ExposureProgram",34852:"SpectralSensitivity",34853:"GPSTag",34855:"ISOSpeedRatings",34856:"OECF",34857:"Interlace",34858:"TimeZoneOffset",34859:"SelfTimerMode",36867:"DateTimeOriginal",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37387:"FlashEnergy",37388:"SpatialFrequencyResponse",37389:"Noise",37390:"FocalPlaneXResolution",37391:"FocalPlaneYResolution",37392:"FocalPlaneResolutionUnit",37393:"ImageNumber",37394:"SecurityClassification",37395:"ImageHistory",37396:"SubjectLocation",37397:"ExposureIndex",37398:"TIFFEPStandardID",37399:"SensingMethod",40091:"XPTitle",40092:"XPComment",40093:"XPAuthor",40094:"XPKeywords",40095:"XPSubject",50341:"PrintImageMatching",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"LensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50739:"ShadowScale",50740:"DNGPrivateData",50741:"MakerNoteSafety",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50781:"RawDataUniqueID",50827:"OriginalRawFileName",50828:"OriginalRawFileData",50829:"ActiveArea",50830:"MaskedAreas",50831:"AsShotICCProfile",50832:"AsShotPreProfileMatrix",50833:"CurrentICCProfile",50834:"CurrentPreProfileMatrix",50879:"ColorimetricReference",50931:"CameraCalibrationSignature",50932:"ProfileCalibrationSignature",50933:"ExtraCameraProfiles",50934:"AsShotProfileName",50935:"NoiseReductionApplied",50936:"ProfileName",50937:"ProfileHueSatMapDims",50938:"ProfileHueSatMapData1",50939:"ProfileHueSatMapData2",50940:"ProfileToneCurve",50941:"ProfileEmbedPolicy",50942:"ProfileCopyright",50964:"ForwardMatrix1",50965:"ForwardMatrix2",50966:"PreviewApplicationName",50967:"PreviewApplicationVersion",50968:"PreviewSettingsName",50969:"PreviewSettingsDigest",50970:"PreviewColorSpace",50971:"PreviewDateTime",50972:"RawImageDigest",50973:"OriginalRawFileDigest",50974:"SubTileBlockSize",50975:"RowInterleaveFactor",50981:"ProfileLookTableDims",50982:"ProfileLookTableData",51008:"OpcodeList1",51009:"OpcodeList2",51022:"OpcodeList3",51041:"NoiseProfile",51043:"TimeCodes",51044:"FrameRate",51058:"TStop",51081:"ReelName",51105:"CameraLabel",51089:"OriginalDefaultFinalSize",51090:"OriginalBestQualityFinalSize",51091:"OriginalDefaultCropSize",51107:"ProfileHueSatMapEncoding",51108:"ProfileLookTableEncoding",51109:"BaselineExposureOffset",51110:"DefaultBlackRender",51111:"NewRawImageDigest",51112:"RawToPreviewGain",51125:"DefaultUserCrop",51177:"DepthFormat",51178:"DepthNear",51179:"DepthFar",51180:"DepthUnits",51181:"DepthMeasureType",51182:"EnhanceParams",52525:"ProfileGainTableMap",52526:"SemanticName",52528:"SemanticInstanceID",52529:"CalibrationIlluminant3",52530:"CameraCalibration3",52531:"ColorMatrix3",52532:"ForwardMatrix3",52533:"IlluminantData1",52534:"IlluminantData2",52535:"IlluminantData3",52536:"MaskSubArea",52537:"ProfileHueSatMapData3",52538:"ReductionMatrix3",52539:"RGBTables"};O.Photo={33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"DateTimeDigitized",36880:"OffsetTime",36881:"OffsetTimeOriginal",36882:"OffsetTimeDigitized",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBiasValue",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37396:"SubjectArea",37500:"MakerNote",37510:"UserComment",37520:"SubSecTime",37521:"SubSecTimeOriginal",37522:"SubSecTimeDigitized",37888:"Temperature",37889:"Humidity",37890:"Pressure",37891:"WaterDepth",37892:"Acceleration",37893:"CameraElevationAngle",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",40964:"RelatedSoundFile",40965:"InteroperabilityTag",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"CameraOwnerName",42033:"BodySerialNumber",42034:"LensSpecification",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42080:"CompositeImage",42081:"SourceImageNumberOfCompositeImage",42082:"SourceExposureTimesOfCompositeImage",42240:"Gamma"};O.Iop={1:"InteroperabilityIndex",2:"InteroperabilityVersion",4096:"RelatedImageFileFormat",4097:"RelatedImageWidth",4098:"RelatedImageLength"};O.GPSInfo={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"}});var re=se((De,oe)=>{var B=ne();oe.exports=function(h){var l=0;if(h.toString("ascii",0,3)!=="MM\0"&&h.toString("ascii",0,3)!=="II*"&&(l=6,h.toString("ascii",0,5)!=="Exif\0"))throw new Error('Invalid EXIF data: buffer should start with "Exif", "MM" or "II".');var e=null;if(h[l]===73&&h[l+1]===73)e=!1;else if(h[l]===77&&h[l+1]===77)e=!0;else throw new Error("Invalid EXIF data: expected byte order marker.");if(h.length<l+4||G(h,l+2,e)!==42)throw new Error("Invalid EXIF data: expected 0x002A.");if(h.length<=l+8)throw new Error("Invalid EXIF data: Ends before ifdOffset");var t=$(h,l+4,e)+l;if(t<8)throw new Error("Invalid EXIF data: ifdOffset < 8");var s={bigEndian:e};if(s.Image=z(h,t,e,B.Image,l),h.length>=t+2){var a=G(h,t,e);h.length>=t+2+a*12+4&&(t=$(h,t+2+a*12,e),t!==0&&(s.Thumbnail=z(h,t+l,e,B.Image,l)))}return s.Image&&(K(s.Image.ExifTag)&&(s.Photo=z(h,s.Image.ExifTag+l,e,B.Photo,l)),K(s.Image.GPSTag)&&(s.GPSInfo=z(h,s.Image.GPSTag+l,e,B.GPSInfo,l))),s.Photo&&K(s.Photo.InteroperabilityTag)&&(s.Iop=z(h,s.Photo.InteroperabilityTag+l,e,B.Iop,l)),s};var fe={DateTimeOriginal:!0,DateTimeDigitized:!0,DateTime:!0};function z(h,l,e,t,s){if(h.length<l+2)return null;var a=G(h,l,e);l+=2;for(var o={},n=0;n<a;n++){if(h.length>=l+2)var i=G(h,l,e);else return null;l+=2;var r=t[i]||i,c=xe(h,l,e,s);r in fe&&(c=ye(c)),o[r]=c,l+=10}return o}var ie=[1,1,2,4,8,1,1,2,4,8];function xe(h,l,e,t){if(h.length<l+7)return null;var s=G(h,l,e);if(!s||s>ie.length)return null;var a=$(h,l+2,e),o=ie[s-1],n;if(o*a<=4)n=l+6;else if(h.length>=l+10)n=$(h,l+6,e)+t;else return null;if(s===2){var i=h.slice(n,n+a);if(i.some(u=>u>>7>0))return i;var r=i.toString("ascii");return r[r.length-1]==="\0"&&(r=r.slice(0,-1)),r}if(s===7)return h.slice(n,n+a);if(a===1)return ae(h,n,e,s);for(var c=[],g=0;g<a&&n<h.length;g++)c.push(ae(h,n,e,s)),n+=o;return c}function ae(h,l,e,t){switch(t){case 1:return h.length<l+1?null:h[l];case 3:return h.length<l+2?null:G(h,l,e);case 4:return h.length<l+4?null:$(h,l,e);case 5:return h.length<l+8?null:$(h,l,e)/$(h,l+4,e);case 6:return h.length<l+1?null:h.readInt8(l);case 8:return h.length<l+2?null:we(h,l,e);case 9:return h.length<l+4?null:J(h,l,e);case 10:return h.length<l+8?null:J(h,l,e)/J(h,l+4,e)}}function ye(h){if(typeof h!="string")return null;var l=h.match(/^(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})$/);return l?new Date(Date.UTC(l[1],l[2]-1,l[3],l[4],l[5],l[6],0)):null}function K(h){return typeof h=="number"&&Math.floor(h)===h&&h>0}function G(h,l,e){return e?h.readUInt16BE(l):h.readUInt16LE(l)}function $(h,l,e){return e?h.readUInt32BE(l):h.readUInt32LE(l)}function we(h,l,e){return e?h.readInt16BE(l):h.readInt16LE(l)}function J(h,l,e){return e?h.readInt32BE(l):h.readInt32LE(l)}});var Te={};pe(Te,{GeminiChatView:()=>j,default:()=>_});module.exports=me(Te);var d=require("obsidian"),be=re();function ke(h){let l="",e=new Uint8Array(h),t=e.byteLength;for(let s=0;s<t;s++)l+=String.fromCharCode(e[s]);return window.btoa(l)}var H="gemini-chat-view",ce=[{keyword:"Research",action:"research",requiresList:!0,enabled:!0},{keyword:"Expand",action:"expand",requiresList:!1,enabled:!0},{keyword:"Summarize",action:"summarize",requiresList:!1,enabled:!0},{keyword:"Summarise",action:"summarize",requiresList:!1,enabled:!0},{keyword:"Actions",action:"actions",requiresList:!1,enabled:!0},{keyword:"Tasks",action:"tasks",requiresList:!0,enabled:!0},{keyword:"Analyze",action:"analyze",requiresList:!1,enabled:!0},{keyword:"Analyse",action:"analyze",requiresList:!1,enabled:!0},{keyword:"Define",action:"define",requiresList:!0,enabled:!0},{keyword:"Translate",action:"translate",requiresList:!1,enabled:!0},{keyword:"Rewrite",action:"rewrite",requiresList:!1,enabled:!0},{keyword:"Questions",action:"questions",requiresList:!1,enabled:!0},{keyword:"Connect",action:"connect",requiresList:!1,enabled:!0},{keyword:"Organise",action:"organize",requiresList:!1,enabled:!0},{keyword:"Organize",action:"organize",requiresList:!1,enabled:!0},{keyword:"TagLinks",action:"taglinks",requiresList:!1,enabled:!0},{keyword:"Related",action:"related",requiresList:!1,enabled:!0}],ee=`You are an expert note-processing assistant integrated into Obsidian. I am providing you with an image of a handwritten note.
Perform the following tasks and format your response *exactly* as specified below, using Markdown.
Do not include any other text, headers, or pleasantries in your response.

IMPORTANT: When transcribing, preserve formatting indicators:
- If a word appears underlined in the handwriting, format it as <u>word</u>
- Maintain numbered or bulleted lists exactly as they appear
- Keep the exact structure and organization of the original note

### Transcript
[Provide a full, verbatim transcript of the text in the image here, preserving all formatting indicators as specified above.]

### Summary
[Provide a concise bullet-point summary of the key points.]

### Tasks
[Extract any actionable tasks or to-do items from the note. Format each as a checkbox item using "- [ ]" followed by the task description.
Include any time indicators mentioned with the task:
- If a due date is mentioned (e.g., "by Friday", "due tomorrow", "by tonight", "before June 1"), include it as "DUE: [date]"
- If a scheduled/planned date is mentioned (e.g., "scheduled for Monday", "on the 15th"), include it as "SCHEDULED: [date]"
- If a start date is mentioned (e.g., "start next week", "begin in January"), include it as "START: [date]"
- If priority is indicated (!, !!, !!!), include it at the beginning
Example format: "- [ ] !!! Task description DUE: tomorrow SCHEDULED: Monday"
If no tasks are found, write "None identified."]

### Detected Tags
[Identify any hashtags (e.g., #idea, #meeting) in the text. List them here as a comma-separated list, without the '#' symbol. For example: idea, meeting, project-alpha. If none are found, write "None identified."]`,le={geminiApiKey:"",selectedModel:"gemini-1.5-flash-latest",customTags:"sketchnote, from-notebook",enableDeepResearch:!1,newNoteLocation:"Gemini Scans/YYYY",attachmentLocation:"Gemini Scans/YYYY/Attachments",enableLocationTagging:!1,fallbackToCurrentLocation:!1,enableTriggerWords:!1,researchResponseLength:"moderate",triggerActions:ce,notebooks:[],currentNotebookId:"",autoIncrementPage:!0,insertPageNumbers:!0,groupByNotebook:!0,notebookFolderPattern:"Notebooks/{notebook}",androidCameraMode:"ask",enableTasksIntegration:!1,tasksNotePath:"Tasks/Inbox.md",tasksSectionHeading:"## Captured Tasks",taskPriorities:!0,defaultTaskTags:"#captured",geminiPrompt:ee,enableDiscussionLinks:!0,discussionLinkText:"\u{1F4AC} Discuss this note with Gemini",folderMonitor:{enabled:!1,watchFolder:"Inbox",filePattern:"scan-*",processedFolder:"Inbox/Processed",outputFolder:"Gemini Scans/Auto-Processed",deleteAfterProcessing:!1,checkInterval:30,useNotebook:!1,notebookId:"",autoIncrementPages:!0,lastProcessedTime:0}},j=class extends d.ItemView{constructor(e,t){super(e);this.plugin=t,this.noteContent="",this.sourceFile=null}getViewType(){return H}getDisplayText(){return"Gemini Chat"}getIcon(){return"message-circle"}async onOpen(){let e=this.containerEl.children[1];if(!(e instanceof HTMLElement)){console.error("Container element is not an HTMLElement");return}let t=e;t.empty(),t.addClass("gemini-chat-view"),this.createChatInterface(t);let s=this.app.workspace.getActiveFile();s&&await this.loadNote(s)}createChatInterface(e){e.style.cssText=`
            display: flex;
            flex-direction: column;
            height: 100%;
        `;let t=e.createDiv({cls:"gemini-chat-header"});t.style.cssText=`
            padding: 10px;
            border-bottom: 1px solid var(--background-modifier-border);
            background: var(--background-secondary);
            flex-shrink: 0;
        `;let s=t.createEl("h4",{text:"Chat with Gemini"});s.style.cssText="margin: 0; font-size: 14px;",this.sourceFileDisplay=t.createEl("div",{cls:"source-file",text:"No note loaded"}),this.sourceFileDisplay.style.cssText=`
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        `,this.chatContainer=e.createDiv({cls:"gemini-chat-messages"}),this.chatContainer.style.cssText=`
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        `;let a=e.createDiv({cls:"gemini-chat-input"});a.style.cssText=`
            padding: 10px;
            border-top: 1px solid var(--background-modifier-border);
            background: var(--background-primary);
            flex-shrink: 0;
        `;let o=a.createDiv({cls:"quick-actions"});o.style.cssText=`
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        `,[{icon:"\u{1F4A1}",text:"Elaborate",prompt:"Can you elaborate on the main points?"},{icon:"\u2753",text:"Questions",prompt:"What questions should I be asking?"},{icon:"\u{1F517}",text:"Related",prompt:"What related topics should I explore?"}].forEach(({icon:r,text:c,prompt:g})=>{let u=o.createEl("button",{text:`${r} ${c}`,cls:"clickable-icon"});u.style.cssText="font-size: 11px; padding: 3px 6px;",u.onclick=()=>{this.inputField.value=g,this.sendMessage()}});let i=a.createDiv({cls:"input-container"});i.style.cssText="display: flex; gap: 8px;",this.inputField=i.createEl("textarea",{cls:"gemini-input",attr:{placeholder:"Ask Gemini about this note...",rows:"2"}}),this.inputField.style.cssText=`
            flex: 1;
            resize: none;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--background-modifier-border);
            font-size: 14px;
        `,this.sendButton=i.createEl("button",{cls:"mod-cta",text:"\u27A4"}),this.sendButton.style.cssText=`
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-self: flex-end;
        `,this.sendButton.onclick=()=>this.sendMessage(),this.inputField.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),this.sendMessage())}),this.inputField.addEventListener("input",()=>{this.inputField.style.height="auto",this.inputField.style.height=Math.min(this.inputField.scrollHeight,120)+"px"})}async loadNote(e){this.sourceFile=e,this.noteContent=await this.app.vault.read(e),this.sourceFileDisplay.setText(`Discussing: ${e.basename}`),this.chatContainer.empty();let t=await this.getDiscussionPath(e),s=this.app.vault.getAbstractFileByPath(t);if(s instanceof d.TFile){let a=await this.app.vault.read(s),o=this.parseDiscussionHistory(a);o.forEach(n=>{this.addMessage(n.question,"user"),this.addMessage(n.response,"assistant")}),o.length>0&&this.addDivider("Previous discussion loaded")}this.chatContainer.children.length===0&&this.addMessage(`I'm ready to discuss "${e.basename}". What would you like to know?`,"assistant")}async sendMessage(){let e=this.inputField.value.trim();if(!e||!this.sourceFile)return;this.inputField.disabled=!0,this.sendButton.disabled=!0,this.addMessage(e,"user"),this.inputField.value="",this.inputField.style.height="auto";let t=this.addMessage("Thinking...","assistant");t.style.opacity="0.6";try{let s=await this.plugin.discussWithGemini(this.noteContent,e);if(this.chatContainer.removeChild(t),this.addMessage(s,"assistant"),this.sourceFile){let a=await this.getDiscussionPath(this.sourceFile);await this.plugin.appendToDiscussionFile(a,e,s,this.sourceFile)}}catch(s){this.chatContainer.removeChild(t),this.addMessage("Failed to get response. Please try again.","error"),console.error("Gemini chat error:",s)}finally{this.inputField.disabled=!1,this.sendButton.disabled=!1,this.inputField.focus()}}addMessage(e,t){let s=this.chatContainer.createDiv({cls:`gemini-message gemini-message-${t}`}),a=`
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        `;return t==="user"?s.style.cssText=a+`
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                align-self: flex-end;
                margin-left: auto;
            `:t==="assistant"?s.style.cssText=a+`
                background: var(--background-secondary);
                align-self: flex-start;
            `:s.style.cssText=a+`
                background: var(--background-modifier-error);
                align-self: center;
            `,d.MarkdownRenderer.renderMarkdown(e,s,"",this.plugin),this.chatContainer.scrollTop=this.chatContainer.scrollHeight,s}addDivider(e){let t=this.chatContainer.createDiv({cls:"chat-divider"});t.style.cssText=`
            text-align: center;
            color: var(--text-muted);
            font-size: 11px;
            margin: 10px 0;
            position: relative;
        `,t.setText(e)}async getDiscussionPath(e){var a;let t=((a=e.parent)==null?void 0:a.path)||"",s=`${e.basename} - Discussion.md`;return t?`${t}/${s}`:s}parseDiscussionHistory(e){let t=[],s=/## Discussion Entry - .*?\n\n\*\*Question:\*\* (.*?)\n\n\*\*Gemini's Response:\*\*\n([\s\S]*?)(?=\n---\n|$)/g,a;for(;(a=s.exec(e))!==null;)t.push({question:a[1],response:a[2].trim()});return t}async onClose(){}},Q=class{constructor(l){this.intervalId=null;this.isProcessing=!1;this.processedFiles=new Set;this.plugin=l}isRunning(){return this.intervalId!==null}start(){if(!this.plugin.settings.folderMonitor.enabled)return;console.log("Starting folder monitor for:",this.plugin.settings.folderMonitor.watchFolder),this.stop(),this.checkFolder();let l=this.plugin.settings.folderMonitor.checkInterval*1e3;this.intervalId=window.setInterval(()=>{this.checkFolder()},l)}stop(){this.intervalId&&(window.clearInterval(this.intervalId),this.intervalId=null,console.log("Stopped folder monitor"))}async checkFolder(){if(this.isProcessing){console.log("Folder monitor: Already processing, skipping check");return}let l=this.plugin.settings.folderMonitor,e=this.plugin.app.vault.getAbstractFileByPath(l.watchFolder);if(!e||!(e instanceof d.TFolder)){console.log("Watch folder not found:",l.watchFolder);return}let t=await this.getMatchingFiles(e);if(t.length!==0){console.log(`Found ${t.length} files to process`),this.isProcessing=!0;try{await this.processFiles(t)}catch(s){console.error("Error processing files:",s),new d.Notice("Folder monitor: Error processing files. Check console.")}finally{this.isProcessing=!1}}}async getMatchingFiles(l){let e=this.plugin.settings.folderMonitor,t=[],s=e.filePattern.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*").replace(/\?/g,"."),a=new RegExp(`^${s}\\.(png|pdf)$`,"i");for(let o of l.children)if(o instanceof d.TFile){if(!a.test(o.name)||o.stat.ctime<=e.lastProcessedTime||this.processedFiles.has(o.path))continue;t.push(o)}return t}async processFiles(l){let e=this.plugin.settings.folderMonitor,t=null,s=null;e.useNotebook&&e.notebookId&&(t=this.plugin.settings.notebooks.find(o=>o.id===e.notebookId)||null,s=(t==null?void 0:t.currentPage)||null);let a=new d.Notice(`Processing ${l.length} files from monitored folder...`,0);for(let o=0;o<l.length;o++){let n=l[o];a.setMessage(`Processing ${o+1}/${l.length}: ${n.name}`);try{n.extension.toLowerCase()==="pdf"?await this.processPdfFile(n,t,s):await this.processImageFile(n,t,s),this.processedFiles.add(n.path),t&&s&&e.autoIncrementPages&&(s++,t.currentPage=s),await this.handleProcessedFile(n),o<l.length-1&&await new Promise(i=>setTimeout(i,1e3))}catch(i){console.error(`Failed to process ${n.name}:`,i),new d.Notice(`Failed to process ${n.name}`)}}e.lastProcessedTime=Date.now(),await this.plugin.saveSettings(),t&&await this.plugin.saveSettings(),a.hide(),new d.Notice(`\u2705 Processed ${l.length} files from monitored folder`)}async processImageFile(l,e,t){let s=this.plugin.settings.folderMonitor,a=await this.plugin.app.vault.readBinary(l),o=await this.plugin.callGeminiAPI(a);if(!o)throw new Error("API call returned no text.");this.plugin.settings.enableTriggerWords&&(o=await this.plugin.processTriggersInText(o));let n=null;this.plugin.settings.enableLocationTagging&&(n=await this.plugin.extractLocationFromImage(a));let i=this.plugin.parseDetectedTags(o),r=await this.plugin.getAndEnsureFolder(s.outputFolder),c=window.moment().format("YYYY-MM-DD HH-mm-ss"),g=l.basename,u;e&&t?u=`${g} - Page ${t} - Auto.md`:u=`${g} - ${c}.md`;let p=r?`${r}/${u}`:u,m="";if(this.plugin.settings.enableDiscussionLinks){let D=encodeURIComponent(p);m+=`[${this.plugin.settings.discussionLinkText}](obsidian://gemini-discuss?file=${D})

`}let w=`${await this.plugin.getAndEnsureFolder(this.plugin.settings.attachmentLocation)}/${l.name}`;s.deleteAfterProcessing?m+=`![[${l.path}]]
`:(await this.plugin.app.vault.copy(l,w),m+=`![[${w}]]
`),m+=`
> **Source:** Auto-processed from monitored folder
`,m+=`> **Original file:** ${l.name}
`,e&&t&&(m+=`> **Notebook:** ${e.name} | **Page:** ${t}
`),m+=`
---
${o}
---`;let y=await this.plugin.app.vault.create(p,m),b=s.deleteAfterProcessing?l:this.plugin.app.vault.getAbstractFileByPath(w);await this.plugin.updateNoteProperties(b,y,i,n,(e==null?void 0:e.id)||null,t)}async processPdfFile(l,e,t){new d.Notice(`PDF processing not fully implemented yet for ${l.name}`);let s=this.plugin.settings.folderMonitor,o=`${await this.plugin.getAndEnsureFolder(s.outputFolder)}/${l.name}`;s.deleteAfterProcessing||await this.plugin.app.vault.copy(l,o)}async handleProcessedFile(l){let e=this.plugin.settings.folderMonitor;if(e.deleteAfterProcessing)await this.plugin.app.vault.delete(l),console.log(`Deleted processed file: ${l.name}`);else{let s=`${await this.plugin.getAndEnsureFolder(e.processedFolder)}/${l.name}`;try{await this.plugin.app.fileManager.renameFile(l,s),console.log(`Moved processed file to: ${s}`)}catch(a){console.error(`Failed to move file ${l.name}:`,a)}}}},_=class extends d.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new Z(this.app,this)),this.registerView(H,e=>new j(e,this)),this.addRibbonIcon("camera","Create note from camera or file",()=>{this.createNoteFromImageCapture()}),this.addCommand({id:"open-gemini-chat",name:"Open Gemini Chat",callback:()=>this.activateChatView()}),this.addCommand({id:"process-current-image",name:"Process current image with Gemini",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return t&&t.extension.match(/^(png|jpg|jpeg|gif)$/i)?(e||this.processExistingImage(t),!0):!1}}),this.addCommand({id:"batch-process-images",name:"Batch process images in folder",callback:()=>{this.showBatchProcessModal()}}),this.registerObsidianProtocolHandler("gemini-discuss",async e=>{let t=decodeURIComponent(e.file),s=this.app.vault.getAbstractFileByPath(t);if(s instanceof d.TFile){await this.activateChatView();let a=this.getChatView();a&&await a.loadNote(s)}}),this.addCommand({id:"discuss-with-gemini",name:"Discuss current note with Gemini",editorCallback:async e=>{let t=this.app.workspace.getActiveFile();if(t){await this.activateChatView();let s=this.getChatView();s&&await s.loadNote(t)}}}),this.registerEvent(this.app.workspace.on("active-leaf-change",async e=>{let t=this.getChatView();if(t&&(e==null?void 0:e.view)instanceof d.MarkdownView){let s=e.view.file;s&&await t.loadNote(s)}})),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{!(t instanceof d.TFile)||!t.path.match(/\.(png|jpg|jpeg|gif)$/i)||e.addItem(s=>{s.setTitle("Process note with Gemini").setIcon("sparkle").onClick(async()=>{this.processImageInCurrentNote(t)})})})),this.folderMonitor=new Q(this),this.settings.folderMonitor.enabled&&this.folderMonitor.start(),this.addCommand({id:"check-monitored-folder",name:"Check monitored folder now",callback:()=>{this.settings.folderMonitor.enabled?(this.folderMonitor.checkFolder(),new d.Notice("Checking monitored folder...")):new d.Notice("Folder monitoring is disabled. Enable it in settings.")}})}onunload(){this.folderMonitor&&this.folderMonitor.stop()}async activateChatView(){let e=this.app.workspace.getLeavesOfType(H);if(e.length)return this.app.workspace.revealLeaf(e[0]),e[0];let t=this.app.workspace.getRightLeaf(!1);if(t)return await t.setViewState({type:H,active:!0}),this.app.workspace.revealLeaf(t),t}getChatView(){let e=this.app.workspace.getLeavesOfType(H);return e.length?e[0].view:null}async loadSettings(){let e=await this.loadData();this.settings={...le,...e,folderMonitor:{...le.folderMonitor,...(e==null?void 0:e.folderMonitor)||{}}},this.settings.triggerActions||(this.settings.triggerActions=ce),this.settings.notebooks||(this.settings.notebooks=[]),this.settings.enableTasksIntegration===void 0&&(this.settings.enableTasksIntegration=!1),this.settings.tasksNotePath||(this.settings.tasksNotePath="Tasks/Inbox.md"),this.settings.tasksSectionHeading||(this.settings.tasksSectionHeading="## Captured Tasks"),this.settings.taskPriorities===void 0&&(this.settings.taskPriorities=!0),this.settings.defaultTaskTags||(this.settings.defaultTaskTags="#captured"),(!this.settings.geminiPrompt||this.settings.geminiPrompt.trim()==="")&&(console.log("Initializing Gemini prompt to default"),this.settings.geminiPrompt=ee,await this.saveSettings()),this.settings.enableDiscussionLinks===void 0&&(this.settings.enableDiscussionLinks=!0),this.settings.discussionLinkText||(this.settings.discussionLinkText="\u{1F4AC} Discuss this note with Gemini")}async saveSettings(){await this.saveData(this.settings)}async processExistingImage(e,t){let a={...{createNewNote:!1,insertInCurrentNote:!0,notebook:null,pageNumber:null},...t};if(!this.settings.geminiApiKey){new d.Notice("Gemini API key is not set.");return}if(!a.createNewNote&&!a.insertInCurrentNote){let o=await this.showImageProcessingChoiceModal(e);if(!o)return;a.createNewNote=o==="new",a.insertInCurrentNote=o==="current"}new d.Notice(`Processing ${e.name} with Gemini...`);try{let o=await this.app.vault.readBinary(e),n=await this.callGeminiAPI(o);if(!n)throw new Error("API call returned no text.");this.settings.enableTriggerWords&&(n=await this.processTriggersInText(n));let i=null;this.settings.enableLocationTagging&&(i=await this.extractLocationFromImage(o));let r=this.parseDetectedTags(n);if(a.createNewNote)await this.createNoteFromExistingImage(e,n,r,i,a.notebook,a.pageNumber);else if(a.insertInCurrentNote){let c=this.app.workspace.getActiveFile();c&&c.extension==="md"?await this.insertProcessedTextInNote(c,e,n,r,i):(new d.Notice("No active markdown file to insert into. Creating new note instead."),await this.createNoteFromExistingImage(e,n,r,i,a.notebook,a.pageNumber))}new d.Notice(`Successfully processed ${e.name}!`)}catch(o){console.error("Error processing existing image:",o),new d.Notice(`Failed to process ${e.name}. Check console.`)}}async createNoteFromExistingImage(e,t,s,a,o,n){let i="";o&&this.settings.groupByNotebook?i=await this.getAndEnsureFolder(await this.getNotebookFolder(o.id)):i=await this.getAndEnsureFolder(this.settings.newNoteLocation);let r=window.moment().format("YYYY-MM-DD HH-mm-ss"),c=e.basename,g;o&&n?g=`${c} - Page ${n} - Processed.md`:g=`${c} - Processed ${r}.md`;let u=i?`${i}/${g}`:g,p="";if(this.settings.enableDiscussionLinks){let f=encodeURIComponent(u);p+=`[${this.settings.discussionLinkText}](obsidian://gemini-discuss?file=${f})

`}p+=`![[${e.path}]]
`,p+=`
> **Source:** Existing image processed on ${window.moment().format("YYYY-MM-DD")}
`,o&&n&&(p+=`> **Notebook:** ${o.name} | **Page:** ${n}
`),p+=`
---
${t}
---`;let m=await this.app.vault.create(u,p);await this.updateNoteProperties(e,m,s,a,(o==null?void 0:o.id)||null,n),this.app.workspace.openLinkText(m.path,"",!0)}async insertProcessedTextInNote(e,t,s,a,o){var u;let n=(u=this.app.workspace.activeEditor)==null?void 0:u.editor;if(!n)return;let i=n.getCursor(),r=n.getLine(i.line),c=`

`;if(this.settings.enableDiscussionLinks){let p=encodeURIComponent(e.path);c+=`[${this.settings.discussionLinkText}](obsidian://gemini-discuss?file=${p})

`}let g=await this.app.vault.read(e);!g.includes(`[[${t.path}]]`)&&!g.includes(`![[${t.path}]]`)&&(c+=`![[${t.path}]]

`),c+=`---
### Processed from ${t.name}
${s}
---`,n.replaceRange(c,{line:i.line,ch:r.length}),await this.updateNoteProperties(t,e,a,o,null,null)}async showImageProcessingChoiceModal(e){return new Promise(t=>{let s=new d.Modal(this.app);s.titleEl.setText(`Process ${e.name}`);let a=s.contentEl;a.style.cssText="text-align: center; padding: 20px;",a.createEl("p",{text:"How would you like to process this image?",cls:"setting-item-description"});let o=a.createDiv();o.style.cssText="display: flex; gap: 10px; justify-content: center; margin-top: 20px;";let n=o.createEl("button",{text:"\u{1F4DD} Insert in Current Note",cls:"mod-cta"}),i=o.createEl("button",{text:"\u{1F4C4} Create New Note"}),r=o.createEl("button",{text:"Cancel"});n.onclick=()=>{s.close(),t("current")},i.onclick=()=>{s.close(),t("new")},r.onclick=()=>{s.close(),t(null)},s.open()})}async showBatchProcessModal(){let e=new d.Modal(this.app);e.titleEl.setText("Batch Process Images");let t=e.contentEl;t.style.cssText="padding: 20px;",t.createEl("h3",{text:"Select Folder"}),t.createEl("p",{text:"Choose a folder containing images to process",cls:"setting-item-description"});let s=[],a=this.app.vault.getRoot(),o=b=>{for(let D of b.children)D instanceof d.TFolder&&(s.push(D.path),o(D))};a instanceof d.TFolder&&(s.push("/"),o(a)),s.sort();let n=t.createEl("select",{cls:"dropdown"});n.style.cssText="width: 100%; margin-bottom: 20px;",n.createEl("option",{value:"",text:"-- Select a folder --"}),s.forEach(b=>{n.createEl("option",{value:b,text:b||"/"})});let i=t.createDiv(),r=i.createEl("input",{type:"checkbox",attr:{id:"create-notes"}});r.checked=!0;let c=i.createEl("label",{text:" Create separate notes for each image",attr:{for:"create-notes"}});c.style.marginLeft="5px";let g=t.createDiv();g.style.cssText="margin-top: 20px;";let u=g.createEl("input",{type:"checkbox",attr:{id:"use-notebook"}}),p=g.createEl("label",{text:" Assign to notebook",attr:{for:"use-notebook"}});p.style.marginLeft="5px";let m=g.createEl("select",{cls:"dropdown"});m.style.cssText="margin-left: 10px; display: none;",this.settings.notebooks.forEach(b=>{m.createEl("option",{value:b.id,text:b.name})}),u.onchange=()=>{m.style.display=u.checked?"inline":"none"};let f=t.createDiv();f.style.cssText="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;";let w=f.createEl("button",{text:"Process Images",cls:"mod-cta"}),y=f.createEl("button",{text:"Cancel"});w.onclick=async()=>{let b=n.value;if(!b){new d.Notice("Please select a folder");return}e.close();let D=this.app.vault.getAbstractFileByPath(b);if(!(D instanceof d.TFolder)){new d.Notice("Invalid folder selected");return}let S=D.children.filter(I=>I instanceof d.TFile&&I.extension.match(/^(png|jpg|jpeg|gif)$/i));if(S.length===0){new d.Notice("No images found in selected folder");return}let C=u.checked?this.settings.notebooks.find(I=>I.id===m.value):null,N=(C==null?void 0:C.currentPage)||1,A=new d.Notice(`Processing ${S.length} images...`,0);for(let I=0;I<S.length;I++){A.setMessage(`Processing ${I+1}/${S.length}: ${S[I].name}`);try{await this.processExistingImage(S[I],{createNewNote:r.checked,insertInCurrentNote:!1,notebook:C,pageNumber:C?N+I:null}),await new Promise(V=>setTimeout(V,1e3))}catch(V){console.error(`Failed to process ${S[I].name}:`,V)}}C&&(C.currentPage=N+S.length,await this.saveSettings()),A.hide(),new d.Notice(`Processed ${S.length} images successfully!`)},y.onclick=()=>e.close(),e.open()}async discussWithGemini(e,t){var r,c,g,u,p;let s=this.settings.geminiApiKey,o=`https://generativelanguage.googleapis.com/v1beta/models/${this.settings.selectedModel}:generateContent?key=${s}`,i={contents:[{parts:[{text:`You are having a discussion about a note that was previously processed. Here is the note content:

---
${e}
---

The user has a follow-up question or request:
"${t}"

Please provide a helpful, detailed, and thoughtful response based on the note content and their question. If appropriate, suggest related topics to explore, provide examples, or offer actionable insights.`}]}]};try{let m=await(0,d.requestUrl)({url:o,method:"POST",contentType:"application/json",body:JSON.stringify(i)});if((p=(u=(g=(c=(r=m.json.candidates)==null?void 0:r[0])==null?void 0:c.content)==null?void 0:g.parts)==null?void 0:u[0])!=null&&p.text)return m.json.candidates[0].content.parts[0].text;throw new Error("No valid response from Gemini")}catch(m){throw console.error("Gemini discussion failed:",m),m}}async appendToDiscussionFile(e,t,s,a){let o=this.app.vault.getAbstractFileByPath(e),n=window.moment().format("YYYY-MM-DD HH:mm");if(o instanceof d.TFile){let i=await this.app.vault.read(o),r=`

---

## Discussion Entry - ${n}

**Question:** ${t}

**Gemini's Response:**
${s}`,c=i+r;await this.app.vault.modify(o,c)}else{let i=`# Discussion: [[${a.basename}]]

## Discussion Entry - ${n}

**Question:** ${t}

**Gemini's Response:**
${s}

---
*Source note: [[${a.basename}]]*
*Created: ${n}*`;await this.app.vault.create(e,i)}}async getNotebookFolder(e){let t=this.settings.notebooks.find(a=>a.id===e);if(!t)return this.settings.newNoteLocation;let s=this.settings.notebookFolderPattern;return s=s.replace("{notebook}",t.name.replace(/[\\/:*?"<>|]/g,"-")),s=s.replace(/YYYY/g,window.moment().format("YYYY")),s=s.replace(/MM/g,window.moment().format("MM")),s=s.replace(/DD/g,window.moment().format("DD")),s}createNotebook(){return{id:Date.now().toString(),name:`Notebook ${this.settings.notebooks.length+1}`,startDate:new Date().toISOString(),currentPage:1,status:"active",description:""}}async showNotebookSelectionModal(){if(this.settings.notebooks.length===0){new d.Notice("No notebooks found. Creating a default notebook...");let e=this.createNotebook();e.name="My Notebook",this.settings.notebooks.push(e),await this.saveSettings()}return new Promise(e=>{let t=new d.Modal(this.app);t.titleEl.setText("Select Notebook & Page"),t.modalEl.style.cssText=`
                width: 90vw;
                max-width: 1200px;
                height: 80vh;
                max-height: 800px;
            `;let s=null,a=null,o=t.contentEl.createDiv();o.style.cssText="display: flex; flex-direction: column; height: 100%;";let n=o.createDiv({cls:"notebook-header"});n.style.cssText="padding: 15px; border-bottom: 1px solid var(--background-modifier-border); flex-shrink: 0;",n.createEl("h3",{text:"Choose Notebook"});let i=n.createDiv({cls:"setting-item"});i.style.cssText="display: flex; align-items: center; gap: 15px;",i.createEl("label",{text:"Notebook:"});let r=i.createEl("select",{cls:"dropdown"});r.style.cssText="flex: 1; max-width: 300px;",r.createEl("option",{value:"",text:"\u{1F4C4} Loose paper / No notebook"});let c=this.settings.notebooks.filter(T=>T.status==="active");if(c.length>0){let T=r.createEl("optgroup",{attr:{label:"Active Notebooks"}});c.forEach(v=>{T.createEl("option",{value:v.id,text:`\u{1F4D3} ${v.name} (${v.currentPage} pages)`})})}let g=this.settings.notebooks.filter(T=>T.status==="completed");if(g.length>0){let T=r.createEl("optgroup",{attr:{label:"Completed Notebooks"}});g.forEach(v=>{T.createEl("option",{value:v.id,text:`\u{1F4D5} ${v.name} (Completed)`})})}let u=i.createDiv({cls:"new-page-input"});u.style.cssText="display: flex; align-items: center; gap: 10px;",u.createEl("label",{text:"New page #:"});let p=u.createEl("input",{type:"number",attr:{min:"1",placeholder:"Page number"}});p.style.cssText="width: 100px;";let m=o.createDiv({cls:"page-browser"});m.style.cssText="flex: 1; overflow-y: auto; padding: 15px; background: var(--background-secondary);";let f=m.createDiv();f.style.cssText="margin-bottom: 15px;";let w=f.createEl("h4",{text:"Recent Pages"}),y=f.createEl("span",{cls:"setting-item-description",text:" - Select a page or enter a new page number above"}),b=m.createDiv({cls:"page-grid"});b.style.cssText=`
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
                padding: 10px;
            `;let D=async T=>{var E;if(b.empty(),!T){w.setText("Recent Loose Pages"),await S();return}let v=this.settings.notebooks.find(x=>x.id===T);if(!v)return;s=v,w.setText(`Pages from ${v.name}`),p.value=v.currentPage.toString(),a=v.currentPage;let U=this.app.vault.getMarkdownFiles(),L=[];for(let x of U){let k=this.app.metadataCache.getFileCache(x);if(((E=k==null?void 0:k.frontmatter)==null?void 0:E.notebook_id)===T){let P=k.frontmatter.page||0,F=k.frontmatter.image;L.push({file:x,page:P,image:F})}}L.sort((x,k)=>k.page-x.page),y.setText(` - ${L.length} pages found`);let M=b.createDiv({cls:"page-card new-page"});M.style.cssText=`
                    border: 2px dashed var(--interactive-accent);
                    border-radius: 8px;
                    padding: 20px;
                    cursor: pointer;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 250px;
                    background: var(--background-primary);
                    transition: all 0.2s ease;
                `,M.innerHTML=`
                    <div style="font-size: 48px; margin-bottom: 10px;">\u2795</div>
                    <div style="font-weight: bold;">Add New Page</div>
                    <div style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">Page ${v.currentPage}</div>
                `,M.addEventListener("mouseenter",()=>{M.style.transform="scale(1.02)",M.style.boxShadow="0 4px 8px rgba(0,0,0,0.2)"}),M.addEventListener("mouseleave",()=>{M.style.transform="scale(1)",M.style.boxShadow="none"}),M.addEventListener("click",()=>{a=v.currentPage,p.value=a.toString(),b.querySelectorAll(".page-card").forEach(x=>{x.removeClass("selected")}),M.addClass("selected"),M.style.borderColor="var(--interactive-success)",M.style.background="var(--background-modifier-hover)"});for(let x of L){let k=b.createDiv({cls:"page-card"});k.style.cssText=`
                        border: 1px solid var(--background-modifier-border);
                        border-radius: 8px;
                        overflow: hidden;
                        cursor: pointer;
                        background: var(--background-primary);
                        transition: all 0.2s ease;
                        display: flex;
                        flex-direction: column;
                    `;let P=k.createDiv({cls:"page-preview"});if(P.style.cssText=`
                        height: 150px;
                        background: var(--background-modifier-hover);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        overflow: hidden;
                        position: relative;
                    `,x.image){let te=this.app.vault.getFiles().find(q=>q.name===x.image);if(te){let q=P.createEl("img");q.style.cssText="width: 100%; height: 100%; object-fit: cover;",q.src=this.app.vault.getResourcePath(te)}else P.createDiv({text:"\u{1F4C4}",cls:"no-image"}).style.cssText="font-size: 48px; opacity: 0.3;"}else P.createDiv({text:"\u{1F4C4}",cls:"no-image"}).style.cssText="font-size: 48px; opacity: 0.3;";let F=k.createDiv({cls:"page-info"});F.style.cssText="padding: 10px;";let R=F.createEl("div",{text:`Page ${x.page}`,cls:"page-title"});R.style.cssText="font-weight: bold; margin-bottom: 5px;";let W=F.createEl("div",{text:x.file.basename,cls:"page-filename"});W.style.cssText="font-size: 11px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;";let Y=F.createEl("div",{text:window.moment(x.file.stat.mtime).format("MMM DD, YYYY"),cls:"page-date"});Y.style.cssText="font-size: 10px; color: var(--text-faint); margin-top: 3px;",k.addEventListener("mouseenter",()=>{k.style.transform="scale(1.02)",k.style.boxShadow="0 4px 8px rgba(0,0,0,0.2)"}),k.addEventListener("mouseleave",()=>{k.style.transform="scale(1)",k.style.boxShadow="none"}),k.addEventListener("click",()=>{this.app.workspace.getLeaf("tab").openFile(x.file)})}},S=async()=>{var U,L,M;b.empty(),u.style.display="none";let T=this.app.vault.getMarkdownFiles(),v=[];for(let E of T){let x=this.app.metadataCache.getFileCache(E);(U=x==null?void 0:x.frontmatter)!=null&&U.notebook_id||(((L=x==null?void 0:x.frontmatter)==null?void 0:L.tags)||[]).some(P=>P.includes("from-notebook")||P.includes("sketchnote"))&&v.push(E)}v.sort((E,x)=>(x.stat.mtime||0)-(E.stat.mtime||0)),y.setText(` - ${v.length} loose pages found`);for(let E of v.slice(0,20)){let x=this.app.metadataCache.getFileCache(E),k=(M=x==null?void 0:x.frontmatter)==null?void 0:M.image,P=b.createDiv({cls:"page-card"});P.style.cssText=`
                        border: 1px solid var(--background-modifier-border);
                        border-radius: 8px;
                        overflow: hidden;
                        cursor: pointer;
                        background: var(--background-primary);
                        transition: all 0.2s ease;
                    `;let F=P.createDiv({cls:"page-preview"});if(F.style.cssText=`
                        height: 150px;
                        background: var(--background-modifier-hover);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `,k){let W=this.app.vault.getFiles().find(Y=>Y.name===k);if(W){let Y=F.createEl("img");Y.style.cssText="width: 100%; height: 100%; object-fit: cover;",Y.src=this.app.vault.getResourcePath(W)}}else F.createDiv({text:"\u{1F4C4}"}).style.cssText="font-size: 48px; opacity: 0.3;";let R=P.createDiv({cls:"page-info"});R.style.cssText="padding: 10px;",R.createEl("div",{text:E.basename}).style.cssText="font-weight: bold; font-size: 12px; overflow: hidden; text-overflow: ellipsis;",R.createEl("div",{text:window.moment(E.stat.mtime).format("MMM DD, YYYY HH:mm")}).style.cssText="font-size: 10px; color: var(--text-muted); margin-top: 5px;",P.addEventListener("click",()=>{this.app.workspace.getLeaf("tab").openFile(E)}),P.addEventListener("mouseenter",()=>{P.style.transform="scale(1.02)",P.style.boxShadow="0 4px 8px rgba(0,0,0,0.2)"}),P.addEventListener("mouseleave",()=>{P.style.transform="scale(1)",P.style.boxShadow="none"})}};this.settings.currentNotebookId?(r.value=this.settings.currentNotebookId,D(this.settings.currentNotebookId)):S(),r.addEventListener("change",()=>{let T=r.value;T?(u.style.display="flex",D(T)):(s=null,a=null,S())}),p.addEventListener("input",()=>{let T=parseInt(p.value);!isNaN(T)&&T>0&&(a=T)});let C=n.createDiv({cls:"setting-item"});C.style.cssText="margin-top: 10px;";let N=C.createEl("input",{type:"checkbox",attr:{id:"auto-increment-check"}});N.checked=this.settings.autoIncrementPage;let A=C.createEl("label",{text:" Auto-increment page number after capture",attr:{for:"auto-increment-check"}});A.style.marginLeft="5px";let I=o.createDiv({cls:"modal-button-container"});I.style.cssText="padding: 15px; border-top: 1px solid var(--background-modifier-border); display: flex; justify-content: flex-end; gap: 10px;",I.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{t.close(),e({notebook:null,pageNumber:null,cancelled:!0})}),I.createEl("button",{text:"Capture Image",cls:"mod-cta"}).addEventListener("click",async()=>{s&&a&&N.checked&&(s.currentPage=a+1),s&&(this.settings.currentNotebookId=s.id),await this.saveSettings(),t.close(),e({notebook:s,pageNumber:a,cancelled:!1})}),t.open()})}async getCurrentCoords(){return new Promise(e=>{if(!navigator.geolocation){e(null);return}navigator.geolocation.getCurrentPosition(t=>e({latitude:t.coords.latitude,longitude:t.coords.longitude}),t=>{console.error("Geolocation error:",t),e(null)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:6e5})})}async getCountryFromCoords(e,t){var s;try{let o=(await(0,d.requestUrl)({url:`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&zoom=3&accept-language=en`,method:"GET",headers:{"User-Agent":"Obsidian-Gemini-Note-Processor/1.0"}})).json;if((s=o==null?void 0:o.address)!=null&&s.country)return o.address.country.toLowerCase().replace(/\s+/g,"-")}catch(a){console.error("Reverse geocoding failed:",a)}return null}async extractLocationFromImage(e){console.log("=== Starting EXIF Location Extraction ==="),console.log("Image data size:",e.byteLength,"bytes");try{let t=Buffer.from(e);console.log("Buffer created, size:",t.length);let s=be(t);if(console.log("EXIF data parsed successfully"),s&&s.gps&&(console.log("Found gps object:",s.gps),s.gps.Latitude&&s.gps.Longitude)){console.log("GPS Latitude:",s.gps.Latitude),console.log("GPS Longitude:",s.gps.Longitude);let a=await this.getCountryFromCoords(s.gps.Latitude,s.gps.Longitude);if(a)return new d.Notice(`Location from photo: ${a}`),a}}catch(t){console.error("Error parsing EXIF data:",t)}if(this.settings.fallbackToCurrentLocation){console.log("No GPS in photo, falling back to current location...");let t=await this.getCurrentCoords();if(t){console.log("Current location:",t);let s=await this.getCountryFromCoords(t.latitude,t.longitude);if(s)return new d.Notice(`Using current location: ${s}`),s}}return console.log("=== Location extraction completed, no location found ==="),null}async processImageInCurrentNote(e){var t;if(!this.settings.geminiApiKey){new d.Notice("Gemini API key is not set.");return}new d.Notice("Processing with Gemini...");try{let s=await this.app.vault.readBinary(e),a=await this.callGeminiAPI(s);if(!a)throw new Error("API call returned no text.");this.settings.enableTriggerWords&&(a=await this.processTriggersInText(a));let o=null;this.settings.enableLocationTagging&&(o=await this.extractLocationFromImage(s));let n=this.app.workspace.getActiveFile();if(n){let r=this.parseDetectedTags(a);await this.updateNoteProperties(e,n,r,o,null,null)}let i=(t=this.app.workspace.activeEditor)==null?void 0:t.editor;if(a&&i){let r=i.getCursor(),c=i.getLine(r.line),g=`

`;if(this.settings.enableDiscussionLinks&&n){let u=encodeURIComponent(n.path);g+=`[${this.settings.discussionLinkText}](obsidian://gemini-discuss?file=${u})

`}g+=`---
${a}
---`,i.replaceRange(g,{line:r.line,ch:c.length}),new d.Notice("Note processed successfully!")}}catch(s){console.error("Error during image processing:",s),new d.Notice("Failed to process image. Check console.")}}async captureFromAndroidCamera(){if(this.settings.androidCameraMode==="ask"){let e=await this.showAndroidCameraModeModal();if(!e)return null;this.settings.androidCameraMode=e,await this.saveSettings()}return this.settings.androidCameraMode==="gallery"?null:new Promise(e=>{let t=new d.Modal(this.app);t.titleEl.setText("Camera Capture");let s=t.contentEl.createDiv({cls:"camera-container"});s.style.cssText="position: relative; width: 100%; max-width: 500px; margin: 0 auto;";let a=s.createEl("video",{attr:{autoplay:!0,playsinline:!0},cls:"camera-video"});a.style.cssText="width: 100%; height: auto; border-radius: 8px;";let o=document.createElement("canvas"),n=o.getContext("2d"),i=t.contentEl.createDiv({cls:"camera-buttons"});i.style.cssText="display: flex; gap: 10px; justify-content: center; margin-top: 15px;";let r=i.createEl("button",{text:"\u{1F4F8} Capture",cls:"mod-cta"});r.disabled=!0;let c=i.createEl("button",{text:"\u{1F5BC}\uFE0F Use Gallery Instead"}),g=i.createEl("button",{text:"Cancel"}),u=null;if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){s.style.display="none",r.style.display="none";let p=t.contentEl.createDiv({cls:"camera-error"});p.style.cssText="padding: 20px; text-align: center;",p.innerHTML=`
                    <h3>Camera Not Available</h3>
                    <p>Direct camera access is not supported in this version of Obsidian.</p>
                    <p>Click "Use Gallery Instead" to select a photo from your device.</p>
                `,t.open(),c.onclick=()=>{t.close(),e(null)},g.onclick=()=>{t.close(),e(null)};return}navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:!1}).then(p=>{u=p,a.srcObject=u,r.disabled=!1,c.style.display="none"}).catch(p=>{console.error("Camera access failed:",p),s.style.display="none",r.style.display="none";let m=t.contentEl.createDiv({cls:"camera-error"});m.style.cssText="padding: 20px; text-align: center;";let f="<h3>Camera Access Issue</h3>";p.name==="NotAllowedError"||p.name==="PermissionDeniedError"?f+=`
                            <div style="background: var(--background-modifier-error-hover); padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <p><strong>\u26A0\uFE0F Known Android Limitation</strong></p>
                                <p>Obsidian on Android may not have camera permission available.</p>
                            </div>
                            <p><strong>Recommended Solution:</strong></p>
                            <p>Use "Gallery" mode to take photos with your camera app, then select them.</p>
                            <div style="margin-top: 20px;">
                                <button class="mod-cta" id="switch-to-gallery">Switch to Gallery Mode</button>
                            </div>`:f+=`<p>Camera error: ${p.message||p.name}</p>
                                <p>Try using Gallery mode instead.</p>`,m.innerHTML=f,setTimeout(()=>{let w=t.contentEl.querySelector("#switch-to-gallery");w&&w.addEventListener("click",async()=>{this.settings.androidCameraMode="gallery",await this.saveSettings(),t.close(),e(null)})},0)}),r.onclick=async()=>{!n||!u||(o.width=a.videoWidth,o.height=a.videoHeight,n.drawImage(a,0,0),o.toBlob(async p=>{if(p){let m=await p.arrayBuffer();u==null||u.getTracks().forEach(f=>f.stop()),t.close(),e(m)}else e(null)},"image/jpeg",.9))},c.onclick=()=>{u==null||u.getTracks().forEach(p=>p.stop()),t.close(),e(null)},g.onclick=()=>{u==null||u.getTracks().forEach(p=>p.stop()),t.close(),e(null)},t.onClose=()=>{u==null||u.getTracks().forEach(p=>p.stop())},t.open()})}async showAndroidCameraModeModal(){return new Promise(e=>{let t=new d.Modal(this.app);t.titleEl.setText("Choose Capture Method");let s=t.contentEl;s.style.cssText="text-align: center;",s.createEl("p",{text:"How would you like to capture images on Android?",cls:"setting-item-description"});let a=s.createDiv();a.style.cssText="margin: 20px 0;";let o=a.createDiv({cls:"capture-option"});o.style.cssText="padding: 15px; margin: 10px; border: 1px solid var(--background-modifier-border); border-radius: 8px; cursor: pointer;",o.innerHTML=`
                <h4>\u{1F4F8} Direct Camera</h4>
                <p style="font-size: 0.9em; opacity: 0.8;">Try to use camera directly in Obsidian</p>
                <p style="font-size: 0.8em; color: var(--text-warning);">\u26A0\uFE0F May not work on all Android devices</p>
            `;let n=a.createDiv({cls:"capture-option"});n.style.cssText="padding: 15px; margin: 10px; border: 2px solid var(--interactive-accent); border-radius: 8px; cursor: pointer; background: var(--background-modifier-hover);",n.innerHTML=`
                <h4>\u{1F5BC}\uFE0F Gallery (Recommended)</h4>
                <p style="font-size: 0.9em; opacity: 0.8;">Use your camera app, then select the photo</p>
                <p style="font-size: 0.8em; color: var(--text-success);">\u2713 Works on all devices</p>
            `,o.onclick=()=>{t.close(),e("camera")},n.onclick=()=>{t.close(),e("gallery")};let i=s.createEl("button",{text:"Cancel"});i.style.cssText="margin-top: 10px;",i.onclick=()=>{t.close(),e(null)},t.open()})}async createNoteFromImageCapture(){if(!this.settings.geminiApiKey){new d.Notice("Gemini API key is not set.");return}let{notebook:e,pageNumber:t,cancelled:s}=await this.showNotebookSelectionModal();s||await this.startMultiPageCapture(e,t)}async startMultiPageCapture(e,t){let s=t,a=0,o=!0,n=navigator.userAgent,i=/iPhone|iPad|iPod/i.test(n),r=/Android/i.test(n);for(;o;){let c=e&&s?`Page ${s} of ${e.name}`:"Loose page";new d.Notice(`Capturing: ${c}`);let g=null,u="captured-image.jpg";if(r&&this.settings.androidCameraMode!=="gallery"&&(g=await this.captureFromAndroidCamera(),!g&&this.settings.androidCameraMode==="camera"&&new d.Notice("Camera access failed. Falling back to gallery...")),!g){let p=await this.selectImageFiles(i,r);if(p.files&&p.files.length>0)if(p.files.length>1){await this.processBatchImages(p.files,e,s),e&&s&&(s+=p.files.length,e.currentPage=s,await this.saveSettings()),a+=p.files.length,o=!1;continue}else g=await p.files[0].arrayBuffer(),u=p.files[0].name}if(!g){console.log("No image data received, ending capture session.");break}await this.processCapturedImage(g,u,e,s),a++,e&&s&&this.settings.autoIncrementPage&&(s++,e.currentPage=s,await this.saveSettings()),o=await this.askToContinueCapture(a,e)}a>0&&new d.Notice(`\u2705 Successfully processed ${a} page${a>1?"s":""}`)}async selectImageFiles(e,t){return new Promise(s=>{let a=document.createElement("input");a.type="file",a.accept="image/*",a.multiple=!0,(e||t&&this.settings.androidCameraMode==="camera")&&(a.capture="environment"),a.style.display="none",document.body.appendChild(a),a.onchange=()=>{let o=a.files?Array.from(a.files):[];document.body.removeChild(a),o.sort((n,i)=>n.name.localeCompare(i.name)),o.length>1&&new d.Notice(`Selected ${o.length} images for batch processing`),s({files:o})},a.addEventListener("cancel",()=>{document.body.removeChild(a),s({files:[]})}),a.click()})}async processBatchImages(e,t,s){let a=new d.Notice(`Processing ${e.length} images...`,0),o=s;for(let n=0;n<e.length;n++){let i=e[n];a.setMessage(`Processing image ${n+1} of ${e.length}: ${i.name}`);try{let r=await i.arrayBuffer();await this.processCapturedImage(r,i.name,t,o),t&&o&&o++,n<e.length-1&&await new Promise(c=>setTimeout(c,1e3))}catch(r){console.error(`Error processing ${i.name}:`,r),new d.Notice(`Failed to process ${i.name}. Continuing with next image...`)}}a.hide()}async askToContinueCapture(e,t){return new Promise(s=>{let a=new d.Modal(this.app);a.titleEl.setText("Continue Capturing?");let o=a.contentEl;o.style.cssText="text-align: center; padding: 20px;";let n=o.createDiv();n.style.cssText="margin-bottom: 20px;",n.innerHTML=`
                <div style="font-size: 24px; margin-bottom: 10px;">\u{1F4F8}</div>
                <h3>${e} page${e>1?"s":""} captured</h3>
                ${t?`<p>Notebook: ${t.name}</p>`:"<p>Loose pages</p>"}
            `,o.createEl("p",{text:"Would you like to add another page?",cls:"setting-item-description"});let i=o.createDiv();i.style.cssText="display: flex; gap: 10px; justify-content: center; margin-top: 20px;";let r=i.createEl("button",{text:"\u{1F4F8} Add Another Page",cls:"mod-cta"});r.style.cssText="flex: 1;";let c=i.createEl("button",{text:"\u2705 Done"});c.style.cssText="flex: 1;";let g=o.createDiv();g.style.cssText="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--background-modifier-border);",g.createEl("p",{text:"\u{1F4A1} Tip: You can select multiple images at once from your gallery",cls:"setting-item-description"}),r.onclick=()=>{a.close(),s(!0)},c.onclick=()=>{a.close(),s(!1)},a.scope.register([],"Enter",()=>{a.close(),s(!0)}),a.scope.register([],"Escape",()=>{a.close(),s(!1)}),a.open(),setTimeout(()=>r.focus(),100)})}async processCapturedImage(e,t,s,a,o=!1){var i;let n=o;n||new d.Notice("Uploading and processing image...");try{let r="";s&&this.settings.groupByNotebook?r=await this.getAndEnsureFolder(await this.getNotebookFolder(s.id)):r=await this.getAndEnsureFolder(this.settings.newNoteLocation);let c=await this.getAndEnsureFolder(this.settings.attachmentLocation),g=((i=t.split(".").pop())==null?void 0:i.toLowerCase())||"jpg",u=`GeminiCapture-${Date.now()}.${g}`,p=`${c}/${u}`,m=await this.app.vault.createBinary(p,e),f=await this.callGeminiAPI(e);if(!f)throw new Error("API call returned no text.");this.settings.enableTriggerWords&&(f=await this.processTriggersInText(f));let w=this.parseDetectedTags(f),y=null;this.settings.enableLocationTagging&&(y=await this.extractLocationFromImage(e));let b=window.moment().format("YYYY-MM-DD HH-mm-ss"),D;s&&a?D=`Page ${a} - ${b}.md`:D=`Note ${b}.md`;let S=r?`${r}/${D}`:D,C="";if(this.settings.enableDiscussionLinks){let A=encodeURIComponent(S);C+=`[${this.settings.discussionLinkText}](obsidian://gemini-discuss?file=${A})

`}C+=`![[${m.path}]]
`,s&&a?C+=`
> **Notebook:** ${s.name} | **Page:** ${a}
`:s||(C+=`
> **Source:** Loose paper / No notebook
`),C+=`
---
${f}
---`;let N=await this.app.vault.create(S,C);await this.updateNoteProperties(m,N,w,y,(s==null?void 0:s.id)||null,a),n||(this.app.workspace.openLinkText(N.path,"",!0),new d.Notice("New note created successfully!"))}catch(r){throw console.error("Error creating note from image:",r),n||new d.Notice("Failed to create note. See console."),r}}async findRelatedNotesByTags(e){var i;if(!e||e.length===0)return"No tags found to search for related notes.";let t=this.app.vault.getMarkdownFiles(),s=this.app.workspace.getActiveFile(),a=new Map;for(let r of t){if(s&&r.path===s.path)continue;let c=this.app.metadataCache.getFileCache(r);if(!((i=c==null?void 0:c.frontmatter)!=null&&i.tags))continue;let g=Array.isArray(c.frontmatter.tags)?c.frontmatter.tags:[c.frontmatter.tags],u=e.filter(p=>g.includes(p));u.length>0&&a.set(r.path,{file:r,matchedTags:u,matchCount:u.length})}if(a.size===0)return"No related notes found with matching tags.";let o=Array.from(a.values()).sort((r,c)=>c.matchCount-r.matchCount).slice(0,10),n=`### Related Notes by Tags

`;n+=`Found ${a.size} related notes. Showing top ${Math.min(10,a.size)}:

`;for(let r of o){let c=`[[${r.file.basename}]]`,g=r.matchedTags.map(u=>`#${u}`).join(", ");n+=`- ${c} (${r.matchCount} matching tags: ${g})
`}return n}async processTriggersInText(e){let t=this.detectTriggerWords(e),s=!1;console.log(`Found ${t.length} triggers in text`);let a=t.find(n=>n.action.keyword==="Tasks");if(a&&this.settings.enableTasksIntegration){console.log("Tasks trigger found with content:",a.content);let n=await this.addTasksToTasksNote(a.content);n>0?(s=!0,new d.Notice(`Added ${n} tasks to ${this.settings.tasksNotePath}`)):console.log("No tasks were added (returned 0)")}if(t.length===0)return e;let o=[];for(let n of t){if(n.action.keyword==="Tasks"&&s){o.push(`### Tasks
\u2705 ${n.content.split(`
`).filter(r=>r.trim()).length} tasks added to [[${this.settings.tasksNotePath.replace(".md","")}]]`);continue}if(n.action.action==="taglinks"||n.action.action==="related"){new d.Notice("Finding related notes by tags...");let r=this.parseDetectedTags(e),c=await this.findRelatedNotesByTags(r);o.push(c);continue}new d.Notice(`Processing trigger: ${n.trigger}...`);let i=await this.processTriggerWithGemini(n);i&&o.push(i)}return o.length>0?`${e}

---
## Triggered Actions

${o.join(`

`)}`:e}async addTasksToTasksNote(e){try{let t=this.parseTasksForObsidianTasks(e);if(t.length===0)return console.log("No tasks parsed from content"),0;console.log(`Parsed ${t.length} tasks:`,t);let s=this.app.vault.getAbstractFileByPath(this.settings.tasksNotePath);if(!s){console.log(`Tasks file not found at ${this.settings.tasksNotePath}, creating...`);let g=this.settings.tasksNotePath.substring(0,this.settings.tasksNotePath.lastIndexOf("/"));g&&!await this.app.vault.adapter.exists(g)&&(console.log(`Creating folder: ${g}`),await this.app.vault.createFolder(g));let u=`# Tasks

${this.settings.tasksSectionHeading}
`;console.log("Creating tasks file with initial content"),s=await this.app.vault.create(this.settings.tasksNotePath,u)}if(!(s instanceof d.TFile))return console.error("Tasks file is not a TFile instance"),0;let a=await this.app.vault.read(s);console.log("Current tasks file content length:",a.length);let o=new RegExp(`^${this.settings.tasksSectionHeading}`,"gm"),n=a.match(o),i=t.map(g=>this.formatTaskForObsidianTasks(g)).join(`
`),c=`
### Captured ${window.moment().format("YYYY-MM-DD HH:mm")}

${i}
`;if(console.log("Tasks block to add:",c),n){let g=a.indexOf(n[0])+n[0].length;a=a.slice(0,g)+c+a.slice(g)}else a+=`

${this.settings.tasksSectionHeading}${c}`;return console.log("Writing updated content to tasks file..."),await this.app.vault.modify(s,a),console.log(`Successfully added ${t.length} tasks to ${this.settings.tasksNotePath}`),t.length}catch(t){return console.error("Error adding tasks to tasks note:",t),new d.Notice(`Error adding tasks: ${t.message}`),0}}parseTasksForObsidianTasks(e){let t=[],s=e.split(`
`);console.log(`Parsing tasks from ${s.length} lines of content`);for(let a of s){let o=a.trim();if(!o)continue;console.log(`Processing line: "${o}"`);let n="",i=o,r={};i=i.replace(/^[-*]\s*/,""),i.match(/^!!!|^HIGH:/i)?(n="\u23EB",i=i.replace(/^(!!!|HIGH:)/i,"").trim()):i.match(/^!!|^MEDIUM:/i)?(n="\u{1F53C}",i=i.replace(/^(!!|MEDIUM:)/i,"").trim()):i.match(/^!|^LOW:/i)&&(n="\u{1F53D}",i=i.replace(/^(!|LOW:)/i,"").trim());let c=i.match(/\b(?:by|due)\s+(tomorrow|today|monday|tuesday|wednesday|thursday|friday|saturday|sunday|next\s+\w+|[\w\s]+?)(?=\s*[-,]|\s*$)/i);if(c){let f=this.parseNaturalDate(c[1]);f&&(r.due=f,i=i.replace(c[0],"").trim())}let g=i.match(/\b(?:scheduled|on)\s+(tomorrow|today|monday|tuesday|wednesday|thursday|friday|saturday|sunday|next\s+\w+|[\w\s]+?)(?=\s*[-,]|\s*$)/i);if(g){let f=this.parseNaturalDate(g[1]);f&&(r.scheduled=f,i=i.replace(g[0],"").trim())}let u=i.match(/\b(?:start|begin|starting)\s+(tomorrow|today|monday|tuesday|wednesday|thursday|friday|saturday|sunday|next\s+\w+|[\w\s]+?)(?=\s*[-,]|\s*$)/i);if(u){let f=this.parseNaturalDate(u[1]);f&&(r.start=f,i=i.replace(u[0],"").trim())}let p=[],m=i.match(/#[\w-]+/g);if(m&&(p.push(...m),i=i.replace(/#[\w-]+/g,"").trim()),this.settings.defaultTaskTags){let f=this.settings.defaultTaskTags.split(",").map(w=>{let y=w.trim();return y.startsWith("#")?y:"#"+y});p.push(...f)}i=i.replace(/[,\-]+$/,"").trim(),i&&(console.log(`Added task: "${i}" with priority: "${n}" and dates:`,r),t.push({text:i,priority:n,tags:[...new Set(p)],dates:Object.keys(r).length>0?r:void 0}))}return console.log(`Parsed ${t.length} total tasks`),t}formatTaskForObsidianTasks(e){let t="- [ ] ";return this.settings.taskPriorities&&e.priority&&(t+=e.priority+" "),t+=e.text,e.dates&&(e.dates.due&&(t+=` \u{1F4C5} ${e.dates.due}`),e.dates.scheduled&&(t+=` \u23F3 ${e.dates.scheduled}`),e.dates.start&&(t+=` \u{1F6EB} ${e.dates.start}`)),t+=` \u2795 ${window.moment().format("YYYY-MM-DD")}`,e.tags.length>0&&(t+=" "+e.tags.join(" ")),t}parseNaturalDate(e,t){let s=t||window.moment(),a=e.toLowerCase().trim();if(a==="today"||a==="tonight")return s.format("YYYY-MM-DD");if(a==="tomorrow")return s.clone().add(1,"day").format("YYYY-MM-DD");if(a==="yesterday")return s.clone().subtract(1,"day").format("YYYY-MM-DD");let o=a.match(/^next\s+(monday|tuesday|wednesday|thursday|friday|saturday|sunday|week|month|year)$/);if(o){let i=o[1];if(["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].includes(i)){let r=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].indexOf(i),c=s.clone();return c.day()>=r&&c.add(1,"week"),c.day(r),c.format("YYYY-MM-DD")}if(i==="week")return s.clone().add(1,"week").format("YYYY-MM-DD");if(i==="month")return s.clone().add(1,"month").format("YYYY-MM-DD");if(i==="year")return s.clone().add(1,"year").format("YYYY-MM-DD")}let n=window.moment(e,["YYYY-MM-DD","MM/DD/YYYY","DD/MM/YYYY","MMM DD, YYYY","MMMM DD, YYYY"],!0);return n.isValid()?n.format("YYYY-MM-DD"):null}async getAndEnsureFolder(e){let t=e.trim();if(!t||t==="/")return"";if(e.includes("{notebook}")||(t=t.replace(/YYYY/g,window.moment().format("YYYY")).replace(/MM/g,window.moment().format("MM")).replace(/DD/g,window.moment().format("DD"))),t=t.replace(/\/+$/,""),t=t.replace(/\/+/g,"/"),!await this.app.vault.adapter.exists(t))try{await this.app.vault.createFolder(t)}catch(s){return new d.Notice(`Error creating folder: ${t}.`),console.error("Error creating folder:",s),""}return t}parseDetectedTags(e){if(!e)return[];let t=/### Detected Tags\s*\n(.*?)(?:\n###|$)/s,s=e.match(t);return s&&s[1]&&s[1].toLowerCase().trim()!=="none identified."?s[1].split(",").map(a=>a.trim()).filter(a=>a):[]}async updateNoteProperties(e,t,s=[],a,o,n){let i=new Date().getFullYear(),r=this.settings.customTags.split(",").map(g=>g.trim()).filter(g=>g),c=o?this.settings.notebooks.find(g=>g.id===o):null;await this.app.fileManager.processFrontMatter(t,g=>{g.tags=g.tags||[],Array.isArray(g.tags)||(g.tags=[g.tags]);let u=[`notes${i}`,...r,...s];a&&u.push(a),c&&u.push(`notebook-${c.name.toLowerCase().replace(/\s+/g,"-")}`);for(let p of u)p&&!g.tags.includes(p)&&g.tags.push(p);g.image=e.name,g.created=window.moment().format("YYYY-MM-DD"),c&&(g.notebook=c.name,g.notebook_id=c.id,n&&(g.page=n))})}processExtractedTasks(e){if(!e||e.toLowerCase().trim()==="none identified.")return"None identified.";console.log("Processing tasks section:",e);let t=e.split(`
`),s=[],a=window.moment().format("YYYY-MM-DD"),o="";this.settings.defaultTaskTags&&(o=" "+this.settings.defaultTaskTags.split(",").map(i=>{let r=i.trim();return r.startsWith("#")?r:"#"+r}).join(" "));for(let n of t){let i=n.trim();if(!i)continue;console.log("Processing task line:",i);let r=i.match(/^-\s*\[\s*\]\s*(.+)/),c="";if(r?c=r[1]:i.startsWith("-")||i.startsWith("*")?c=i.replace(/^[-*]\s*/,"").trim():!i.startsWith("#")&&i.length>0&&(c=i),c){let g="",u={};c.match(/^!!!|^HIGH:/i)?(g="\u23EB ",c=c.replace(/^(!!!|HIGH:)/i,"").trim()):c.match(/^!!|^MEDIUM:/i)?(g="\u{1F53C} ",c=c.replace(/^(!!|MEDIUM:)/i,"").trim()):c.match(/^!|^LOW:/i)&&(g="\u{1F53D} ",c=c.replace(/^(!|LOW:)/i,"").trim());let p=c.match(/\bDUE:\s*([^,\s]+(?:\s+[^,\s]+)*?)(?=\s*(?:SCHEDULED:|START:|$))/i);if(p){let y=this.parseNaturalDate(p[1]);y&&(u.due=y,c=c.replace(p[0],"").trim())}let m=c.match(/\bSCHEDULED:\s*([^,\s]+(?:\s+[^,\s]+)*?)(?=\s*(?:DUE:|START:|$))/i);if(m){let y=this.parseNaturalDate(m[1]);y&&(u.scheduled=y,c=c.replace(m[0],"").trim())}let f=c.match(/\bSTART:\s*([^,\s]+(?:\s+[^,\s]+)*?)(?=\s*(?:DUE:|SCHEDULED:|$))/i);if(f){let y=this.parseNaturalDate(f[1]);y&&(u.start=y,c=c.replace(f[0],"").trim())}let w=`- [ ] ${g}${c}`;u.due&&(w+=` \u{1F4C5} ${u.due}`),u.scheduled&&(w+=` \u23F3 ${u.scheduled}`),u.start&&(w+=` \u{1F6EB} ${u.start}`),w+=` \u2795 ${a}`,w+=o,console.log("Formatted task:",w),s.push(w)}}return s.join(`
`)}async callGeminiAPI(e){var r,c,g,u;let t=this.settings.geminiApiKey,a=`https://generativelanguage.googleapis.com/v1beta/models/${this.settings.selectedModel}:generateContent?key=${t}`,o=ke(e),n=this.settings.geminiPrompt;this.settings.enableDeepResearch&&(n+=`

### Deep Research
[Also, identify any product names, technologies, or key concepts mentioned in the note. For each item, provide a brief, one-sentence description and a relevant URL (like an official website or Wikipedia page) for more information. Format each item as a bullet point. If none are found, write "None identified."]`);let i={contents:[{parts:[{text:n},{inline_data:{mime_type:"image/jpeg",data:o}}]}]};try{let m=(await(0,d.requestUrl)({url:a,method:"POST",contentType:"application/json",body:JSON.stringify(i)})).json;if(m.candidates&&((u=(g=(c=(r=m.candidates[0])==null?void 0:r.content)==null?void 0:c.parts)==null?void 0:g[0])!=null&&u.text)){let f=m.candidates[0].content.parts[0].text,w=/### Tasks\s*\n([\s\S]*?)(?=\n###|$)/,y=f.match(w);if(y&&y[1]){console.log("Found Tasks section, processing...");let b=this.processExtractedTasks(y[1]);f=f.replace(y[0],`### Tasks
${b}`)}return f}else throw new Error("Unexpected response structure from Gemini API")}catch(p){throw console.error("Gemini API call failed:",p),p}}detectTriggerWords(e){let t=[],s=/(?:<u>([\w\s]+)<\/u>|__([\w\s]+)__)\s*:?\s*([\s\S]*?)(?=(?:<u>|__|\n\n|$))/gi,a;for(;(a=s.exec(e))!==null;){let o=(a[1]||a[2]).trim(),n=a[3].trim(),i=o.match(/^Translate\s+(?:to|into)\s+(\w+)$/i);if(i){let g=i[1],u=this.settings.triggerActions.find(p=>p.action==="translate"&&p.enabled);u&&t.push({trigger:`Translate to ${g}`,content:n,action:{...u,keyword:`Translate to ${g}`}});continue}let r=o.split(/\s+/)[0],c=this.settings.triggerActions.find(g=>g.keyword.toLowerCase()===r.toLowerCase()&&g.enabled);c&&t.push({trigger:r,content:n,action:c})}return t}async processTriggerWithGemini(e){var r,c,g,u;let t={brief:"Provide a concise response, 2-3 sentences per item.",moderate:"Provide a balanced response, 1-2 paragraphs per item.",detailed:"Provide a comprehensive response with full explanations, examples, and context."},s="";if(e.action.action==="translate"){let p=e.trigger.match(/Translate\s+(?:to|into)\s+(\w+)/i);p&&(s=p[1])}let o={research:`Research the following topics and provide ${t[this.settings.researchResponseLength]} Format as a numbered list matching the input:
${e.content}`,expand:`Take this brief note or concept and expand it into detailed, well-structured paragraphs: 
${e.content}
${t[this.settings.researchResponseLength]}`,summarize:`Create a concise summary of the following content. Include key points and takeaways:
${e.content}`,actions:`Extract all action items from this content and create a prioritized task list with suggested deadlines:
${e.content}`,tasks:`Format the following as a task list:
${e.content}`,analyze:`Provide a critical analysis of the following. Include pros/cons, potential risks, and opportunities:
${e.content}`,define:`Provide clear definitions with examples for these terms:
${e.content}`,translate:s?`Translate the following content to ${s}. Provide only the translation, maintaining the same format and structure as the original:
${e.content}`:`Translate the following content. Target language is specified first, then the content:
${e.content}`,rewrite:`Rewrite the following content in the specified style (formal/casual/technical/email/etc):
${e.content}`,questions:`Generate thought-provoking questions about this topic to encourage deeper thinking:
${e.content}`,connect:`Identify connections to other concepts, related topics, and interdisciplinary links for:
${e.content}`,organize:`Organize the following content into a clear, logical structure with categories and priorities:
${e.content}`,taglinks:"Finding related notes by tags...",related:"Finding related notes by tags..."}[e.action.action]||`Process: ${e.content}`,n=`https://generativelanguage.googleapis.com/v1beta/models/${this.settings.selectedModel}:generateContent?key=${this.settings.geminiApiKey}`,i={contents:[{parts:[{text:o}]}]};try{let m=(await(0,d.requestUrl)({url:n,method:"POST",contentType:"application/json",body:JSON.stringify(i)})).json;if(m.candidates&&((u=(g=(c=(r=m.candidates[0])==null?void 0:r.content)==null?void 0:c.parts)==null?void 0:g[0])!=null&&u.text))return`### ${e.trigger} Results
${m.candidates[0].content.parts[0].text}`}catch(p){return console.error(`Failed to process trigger "${e.trigger}":`,p),`### ${e.trigger} - Processing Failed
Could not process this trigger action.`}return""}},Z=class extends d.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){var o;let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Gemini Note Processor Settings"});let t=e.createDiv({cls:"setting-item"});t.style.cssText="padding: 20px; background: var(--background-modifier-hover); border-radius: 8px; margin-bottom: 20px; text-align: center;",t.createEl("p",{text:"If you find this plugin helpful, consider supporting its development!",cls:"setting-item-description"});let a=t.createEl("a",{href:"https://buymeacoffee.com/farsonic",attr:{target:"_blank"}}).createEl("img",{attr:{src:"https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",alt:"Buy Me A Coffee"}});if(a.style.cssText="height: 60px; width: 217px; margin-top: 10px;",t.createEl("p",{text:"\u2615 Your support helps keep this plugin maintained and improved!",cls:"setting-item-description"}),new d.Setting(e).setName("Gemini API Key").setDesc("Your Google AI Studio API key for Gemini").addText(n=>n.setPlaceholder("Enter your API key").setValue(this.plugin.settings.geminiApiKey).onChange(async i=>{this.plugin.settings.geminiApiKey=i,await this.plugin.saveSettings()})),e.createEl("h2",{text:"Prompt Configuration"}),new d.Setting(e).setName("Gemini Prompt").setDesc("Edit the prompt that tells Gemini how to process your notes (be careful with changes)").addTextArea(n=>{let i="You are an expert note-processing assistant integrated into Obsidian. I am providing you with an image of a handwritten note.",r=this.plugin.settings.geminiPrompt||i;return n.setValue(r),n.inputEl.style.width="100%",n.inputEl.style.height="300px",n.inputEl.style.fontSize="11px",n.inputEl.style.fontFamily="monospace",n.onChange(async c=>{this.plugin.settings.geminiPrompt=c,await this.plugin.saveSettings()}),n}),new d.Setting(e).setName("Reset Prompt").setDesc("Reset the prompt to the default template").addButton(n=>n.setButtonText("Reset to Default").onClick(async()=>{this.plugin.settings.geminiPrompt=ee,await this.plugin.saveSettings(),this.display()})),e.createEl("h2",{text:"Notebook Management"}),new d.Setting(e).setName("Group Notes by Notebook").setDesc("Organize captured notes into notebook-specific folders").addToggle(n=>n.setValue(this.plugin.settings.groupByNotebook).onChange(async i=>{this.plugin.settings.groupByNotebook=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Auto-increment Page Numbers").setDesc("Automatically increment page number after each capture").addToggle(n=>n.setValue(this.plugin.settings.autoIncrementPage).onChange(async i=>{this.plugin.settings.autoIncrementPage=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Notebook Folder Pattern").setDesc("Folder structure for notebook organization. Use {notebook} for notebook name.").addText(n=>n.setPlaceholder("Notebooks/{notebook}/YYYY-MM").setValue(this.plugin.settings.notebookFolderPattern).onChange(async i=>{this.plugin.settings.notebookFolderPattern=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Manage Notebooks"}),e.createEl("p",{text:"Add and manage your physical notebooks.",cls:"setting-item-description"}),new d.Setting(e).setName("Add New Notebook").setDesc("Create a new notebook entry").addButton(n=>n.setButtonText("Add Notebook").onClick(async()=>{let i=this.plugin.createNotebook();this.plugin.settings.notebooks.push(i),await this.plugin.saveSettings(),this.display()})),this.plugin.settings.notebooks.forEach((n,i)=>{let r=new d.Setting(e).setName(n.name).setDesc(`Status: ${n.status} | Current Page: ${n.currentPage}${n.totalPages?`/${n.totalPages}`:""}`);r.addText(c=>c.setPlaceholder("Notebook name").setValue(n.name).onChange(async g=>{n.name=g,await this.plugin.saveSettings()})),r.addText(c=>c.setPlaceholder("Page").setValue(n.currentPage.toString()).onChange(async g=>{let u=parseInt(g);!isNaN(u)&&u>0&&(n.currentPage=u,await this.plugin.saveSettings())})).setTooltip("Current page number"),r.addDropdown(c=>c.addOption("active","Active").addOption("completed","Completed").addOption("archived","Archived").setValue(n.status).onChange(async g=>{n.status=g,await this.plugin.saveSettings(),this.display()})),r.addButton(c=>c.setButtonText("Delete").setWarning().onClick(async()=>{confirm(`Delete notebook "${n.name}"? This won't delete existing notes.`)&&(this.plugin.settings.notebooks.splice(i,1),await this.plugin.saveSettings(),this.display())}))}),e.createEl("h2",{text:"File Organization"}),new d.Setting(e).setName("New Note Location").setDesc("Default folder for new notes (when not using notebooks). Supports YYYY, MM, DD placeholders.").addText(n=>n.setPlaceholder("e.g., Scans/YYYY-MM").setValue(this.plugin.settings.newNoteLocation).onChange(async i=>{this.plugin.settings.newNoteLocation=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Attachment Location").setDesc("Folder for new image attachments. Supports YYYY, MM, DD.").addText(n=>n.setPlaceholder("e.g., Scans/YYYY-MM/Attachments").setValue(this.plugin.settings.attachmentLocation).onChange(async i=>{this.plugin.settings.attachmentLocation=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Custom Tags").setDesc("Comma-separated tags to add to note properties.").addText(n=>n.setPlaceholder("e.g., sketchnote, from-notebook").setValue(this.plugin.settings.customTags).onChange(async i=>{this.plugin.settings.customTags=i,await this.plugin.saveSettings()})),e.createEl("h2",{text:"Processing Options"}),new d.Setting(e).setName("Enable Deep Research").setDesc("Gemini will also research topics found in the note.").addToggle(n=>n.setValue(this.plugin.settings.enableDeepResearch).onChange(async i=>{this.plugin.settings.enableDeepResearch=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Enable Location Tagging").setDesc("Extract location from photo EXIF data and add as a country tag.").addToggle(n=>n.setValue(this.plugin.settings.enableLocationTagging).onChange(async i=>{this.plugin.settings.enableLocationTagging=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Fallback to Current Location").setDesc("If no GPS data in photo, use your current location instead (requires location permission).").addToggle(n=>n.setValue(this.plugin.settings.fallbackToCurrentLocation).onChange(async i=>{this.plugin.settings.fallbackToCurrentLocation=i,await this.plugin.saveSettings()})),e.createEl("h2",{text:"Discussion Settings"}),new d.Setting(e).setName("Enable Discussion Links").setDesc("Add a link to discuss the note with Gemini at the top of processed notes").addToggle(n=>n.setValue(this.plugin.settings.enableDiscussionLinks).onChange(async i=>{this.plugin.settings.enableDiscussionLinks=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.enableDiscussionLinks&&(new d.Setting(e).setName("Discussion Link Text").setDesc("Customize the text for the discussion link").addText(n=>n.setPlaceholder("\u{1F4AC} Discuss this note with Gemini").setValue(this.plugin.settings.discussionLinkText).onChange(async i=>{this.plugin.settings.discussionLinkText=i||"\u{1F4AC} Discuss this note with Gemini",await this.plugin.saveSettings()})),e.createEl("p",{text:"\u{1F4A1} You can also use the command palette (Ctrl/Cmd+P) to open Gemini Chat for any note.",cls:"setting-item-description"})),e.createEl("h2",{text:"Trigger Words"}),new d.Setting(e).setName("Enable Trigger Words").setDesc("Process underlined keywords as special triggers for additional Gemini actions").addToggle(n=>n.setValue(this.plugin.settings.enableTriggerWords).onChange(async i=>{this.plugin.settings.enableTriggerWords=i,this.display()})),this.plugin.settings.enableTriggerWords){new d.Setting(e).setName("Research Response Length").setDesc("How detailed should triggered research responses be?").addDropdown(n=>n.addOption("brief","Brief (2-3 sentences)").addOption("moderate","Moderate (1-2 paragraphs)").addOption("detailed","Detailed (comprehensive)").setValue(this.plugin.settings.researchResponseLength).onChange(async i=>{this.plugin.settings.researchResponseLength=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Trigger Words Configuration"}),e.createEl("p",{text:"Enable/disable specific trigger words. Underline words in your handwritten notes to activate these AI-powered actions.",cls:"setting-item-description"});for(let n of this.plugin.settings.triggerActions){if(n.keyword==="Summarise"&&this.plugin.settings.triggerActions.find(r=>r.keyword==="Summarize")||n.keyword==="Analyse"&&this.plugin.settings.triggerActions.find(r=>r.keyword==="Analyze")||n.keyword==="Organise"&&this.plugin.settings.triggerActions.find(r=>r.keyword==="Organize"))continue;let i=this.getTriggerUsageDescription(n.keyword,n.action);new d.Setting(e).setName(n.keyword).setDesc(i).addToggle(r=>r.setValue(n.enabled).onChange(async c=>{let u={Summarize:["Summarize","Summarise"],Analyze:["Analyze","Analyse"],Organize:["Organize","Organise"]}[n.keyword]||[n.keyword];for(let p of u){let m=this.plugin.settings.triggerActions.findIndex(f=>f.keyword===p);m!==-1&&(this.plugin.settings.triggerActions[m].enabled=c)}await this.plugin.saveSettings()}))}}if(e.createEl("h2",{text:"Obsidian Tasks Integration"}),e.createEl("p",{text:"Integrate with Obsidian Tasks plugin to automatically add captured tasks to your task management system.",cls:"setting-item-description"}),new d.Setting(e).setName("Enable Tasks Integration").setDesc('Automatically add tasks to your Obsidian Tasks note when using the "Tasks" trigger word').addToggle(n=>n.setValue(this.plugin.settings.enableTasksIntegration).onChange(async i=>{this.plugin.settings.enableTasksIntegration=i,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.enableTasksIntegration&&(new d.Setting(e).setName("Tasks Note Path").setDesc("Path to your main tasks note (e.g., Tasks/Inbox.md)").addText(n=>n.setPlaceholder("Tasks/Inbox.md").setValue(this.plugin.settings.tasksNotePath).onChange(async i=>{this.plugin.settings.tasksNotePath=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Tasks Section Heading").setDesc("Heading under which captured tasks will be added").addText(n=>n.setPlaceholder("## Captured Tasks").setValue(this.plugin.settings.tasksSectionHeading).onChange(async i=>{this.plugin.settings.tasksSectionHeading=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Enable Priority Markers").setDesc("Detect priority markers (!, !!, !!!) and add priority emojis to tasks").addToggle(n=>n.setValue(this.plugin.settings.taskPriorities).onChange(async i=>{this.plugin.settings.taskPriorities=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Default Task Tags").setDesc("Tags to add to all captured tasks (comma-separated, # optional)").addText(n=>n.setPlaceholder("#captured, #from-paper").setValue(this.plugin.settings.defaultTaskTags).onChange(async i=>{this.plugin.settings.defaultTaskTags=i,await this.plugin.saveSettings()})),e.createEl("p",{text:'\u{1F4A1} How to use: Underline "Tasks" in your handwritten notes, then list tasks below.',cls:"setting-item-description"})),e.createEl("h2",{text:"Platform-Specific Settings"}),new d.Setting(e).setName("Android Camera Mode").setDesc("Choose how to capture images on Android devices").addDropdown(n=>n.addOption("ask","Ask each time").addOption("camera","Direct camera (may not work)").addOption("gallery","Gallery picker (recommended)").setValue(this.plugin.settings.androidCameraMode).onChange(async i=>{this.plugin.settings.androidCameraMode=i,await this.plugin.saveSettings()})),e.createEl("p",{text:"\u{1F4A1} Tip: If camera access fails on Android, use Gallery mode.",cls:"setting-item-description"}),e.createEl("h2",{text:"Automatic Folder Monitoring"}),e.createEl("p",{text:"Automatically process files that appear in a specified folder.",cls:"setting-item-description"}),new d.Setting(e).setName("Enable Folder Monitoring").setDesc("Automatically monitor and process files from a specified folder").addToggle(n=>n.setValue(this.plugin.settings.folderMonitor.enabled).onChange(async i=>{this.plugin.settings.folderMonitor.enabled=i,await this.plugin.saveSettings(),i?(this.plugin.folderMonitor.start(),new d.Notice("Folder monitoring started")):(this.plugin.folderMonitor.stop(),new d.Notice("Folder monitoring stopped")),this.display()})),this.plugin.settings.folderMonitor.enabled){if(new d.Setting(e).setName("Watch Folder").setDesc("Folder to monitor for new files (relative to vault root)").addText(u=>u.setPlaceholder("Inbox").setValue(this.plugin.settings.folderMonitor.watchFolder).onChange(async p=>{this.plugin.settings.folderMonitor.watchFolder=p,await this.plugin.saveSettings(),this.plugin.folderMonitor.stop(),this.plugin.folderMonitor.start()})),new d.Setting(e).setName("File Pattern").setDesc('Pattern to match files (e.g., "scan-*" matches scan-001.png, scan-002.pdf). Use * for any characters, ? for single character.').addText(u=>u.setPlaceholder("scan-*").setValue(this.plugin.settings.folderMonitor.filePattern).onChange(async p=>{this.plugin.settings.folderMonitor.filePattern=p||"*",await this.plugin.saveSettings()})),new d.Setting(e).setName("Output Folder").setDesc("Where to save processed notes. Supports YYYY, MM, DD placeholders.").addText(u=>u.setPlaceholder("Gemini Scans/Auto-Processed/YYYY-MM").setValue(this.plugin.settings.folderMonitor.outputFolder).onChange(async p=>{this.plugin.settings.folderMonitor.outputFolder=p,await this.plugin.saveSettings()})),new d.Setting(e).setName("Check Interval").setDesc("How often to check for new files (in seconds, minimum 5)").addText(u=>u.setPlaceholder("30").setValue(this.plugin.settings.folderMonitor.checkInterval.toString()).onChange(async p=>{let m=parseInt(p);!isNaN(m)&&m>=5&&(this.plugin.settings.folderMonitor.checkInterval=m,await this.plugin.saveSettings(),this.plugin.folderMonitor.stop(),this.plugin.folderMonitor.start())})),e.createEl("h3",{text:"File Handling"}),new d.Setting(e).setName("After Processing Action").setDesc("What to do with original files after processing").addDropdown(u=>u.addOption("move","Move to Processed folder").addOption("delete","Delete original files").setValue(this.plugin.settings.folderMonitor.deleteAfterProcessing?"delete":"move").onChange(async p=>{this.plugin.settings.folderMonitor.deleteAfterProcessing=p==="delete",await this.plugin.saveSettings(),this.display()})),this.plugin.settings.folderMonitor.deleteAfterProcessing||new d.Setting(e).setName("Processed Folder").setDesc("Where to move processed files").addText(u=>u.setPlaceholder("Inbox/Processed").setValue(this.plugin.settings.folderMonitor.processedFolder).onChange(async p=>{this.plugin.settings.folderMonitor.processedFolder=p,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Notebook Integration"}),new d.Setting(e).setName("Use Notebook").setDesc("Assign auto-processed files to a specific notebook").addToggle(u=>u.setValue(this.plugin.settings.folderMonitor.useNotebook).onChange(async p=>{this.plugin.settings.folderMonitor.useNotebook=p,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.folderMonitor.useNotebook){let u=this.plugin.settings.notebooks.filter(p=>p.status==="active");u.length>0?(new d.Setting(e).setName("Select Notebook").setDesc("Which notebook to use for auto-processed files").addDropdown(p=>{p.addOption("","Select a notebook..."),u.forEach(m=>{p.addOption(m.id,`${m.name} (Page ${m.currentPage})`)}),p.setValue(this.plugin.settings.folderMonitor.notebookId).onChange(async m=>{this.plugin.settings.folderMonitor.notebookId=m,await this.plugin.saveSettings()})}),new d.Setting(e).setName("Auto-increment Pages").setDesc("Automatically increment page numbers for each processed file").addToggle(p=>p.setValue(this.plugin.settings.folderMonitor.autoIncrementPages).onChange(async m=>{this.plugin.settings.folderMonitor.autoIncrementPages=m,await this.plugin.saveSettings()}))):e.createEl("p",{text:"\u26A0\uFE0F No active notebooks found. Create a notebook first.",cls:"setting-item-description"})}e.createEl("h3",{text:"Monitor Status"});let n=e.createDiv({cls:"setting-item"});n.style.cssText="padding: 10px; background: var(--background-modifier-hover); border-radius: 8px;";let i=this.plugin.settings.folderMonitor.lastProcessedTime,r=i?`Last check: ${window.moment(i).fromNow()}`:"Not yet run";n.createEl("p",{text:`Status: ${(o=this.plugin.folderMonitor)!=null&&o.isRunning()?"\u{1F7E2} Running":"\u{1F534} Stopped"}`,cls:"setting-item-description"});let c=n.createDiv();c.style.cssText="display: flex; gap: 10px; margin-top: 10px;",c.createEl("button",{text:"\u{1F504} Check Now",cls:"mod-cta"}).addEventListener("click",async()=>{this.plugin.settings.folderMonitor.enabled?(await this.plugin.folderMonitor.checkFolder(),new d.Notice("Checking monitored folder...")):new d.Notice("Enable folder monitoring first")}),c.createEl("button",{text:"\u{1F504} Restart Monitor"}).addEventListener("click",()=>{this.plugin.folderMonitor.stop(),this.plugin.folderMonitor.start(),new d.Notice("Monitor restarted"),this.display()}),e.createEl("h3",{text:"How it works"});let g=e.createDiv({cls:"setting-item-description"});g.style.cssText="background: var(--background-secondary); padding: 15px; border-radius: 8px;",g.innerHTML=`
                <p><strong>Setup Instructions:</strong></p>
                <ol>
                    <li>Create an "Inbox" folder in your vault for incoming files</li>
                    <li>Set up your scanner/camera app to save files there with a consistent naming pattern (e.g., scan-001.png, scan-002.pdf)</li>
                    <li>Configure the file pattern to match your naming scheme</li>
                    <li>The monitor will check every ${this.plugin.settings.folderMonitor.checkInterval} seconds for new files</li>
                    <li>Matching files will be processed through Gemini and saved as notes</li>
                </ol>
                <p><strong>File Pattern Examples:</strong></p>
                <ul>
                    <li><code>scan-*</code> \u2192 matches scan-001.png, scan-abc.pdf</li>
                    <li><code>note-????</code> \u2192 matches note-0001.png, note-abcd.pdf (exactly 4 characters)</li>
                    <li><code>*</code> \u2192 matches all PNG and PDF files</li>
                    <li><code>IMG_*</code> \u2192 matches IMG_001.png, IMG_20231225.pdf</li>
                </ul>
            `}}getTriggerUsageDescription(e,t){let s={Research:"Deep research on topics you list below the underlined word.",Expand:"Expands brief notes into detailed, well-structured content.",Summarize:"Creates concise summaries of your content.",Actions:"Extracts and prioritizes all action items with suggested deadlines.",Tasks:"Adds tasks to your Obsidian Tasks note with priority and tags support.",Analyze:"Provides critical analysis including pros, cons, risks and opportunities.",Define:"Provides clear definitions with examples for terms listed below.",Translate:"Translates content to your specified language.",Rewrite:"Rewrites content in a different style (formal, casual, email, etc.).",Questions:"Generates thought-provoking questions to encourage deeper thinking.",Connect:"Identifies connections to related concepts and interdisciplinary links.",Organize:"Organizes content into clear, logical structure with categories.",TagLinks:"Finds and links to other notes with matching tags.",Related:"Same as TagLinks - finds notes with matching tags."};return e==="Summarise"?s.Summarize:e==="Analyse"?s.Analyze:e==="Organise"?s.Organize:s[e]||"Process content"}};
